---
import LogoEmber from '@assets/logoEmber.svg';
import { getMenuBySlug } from '@libs/apiWPPods';
import type { MenuItem } from '@libs/types/apiTypes';

// IMPORTANTE: Herramienta oficial para generar links (칰til para el logo)
import { getRelativeLocaleUrl } from 'astro:i18n';

// 1. RECUPERAR IDIOMA NATIVAMENTE
// Astro.currentLocale devuelve 'es', 'en', etc. autom치ticamente.
// Si devuelve undefined (a veces pasa en la ra칤z si no hay prefijo), usamos 'es' por defecto.
const lang = Astro.currentLocale || 'es';

const { isEU } = Astro.props;

// 2. LLAMADA A LA API
// Usamos la ubicaci칩n 'primary' que registraste en PHP.
// Le pasamos el 'lang' que Astro ha detectado.
//console.log(`游깴 Astro i18n detect칩: ${lang}`);
const menuItems: MenuItem[] = await getMenuBySlug('primary', lang);

// 3. LINK DEL LOGO (Nativo de Astro)
// Esto genera autom치ticamente '/' para espa침ol y '/en/' para ingl칠s
// sin que tengas que escribir ifs manuales.
const logoHref = getRelativeLocaleUrl(lang, '/');
---

<header
     class:list={[
      'bg',
      { 'bg--eu': isEU  }   
    ]}
>
    <figure>
        <a href={logoHref}><img src={LogoEmber.src} alt="Logotipo Ember" loading="eager" width="172" height="80"/></a>
    </figure>

    <button id="menu-toggle" class="menu-toggle" aria-label="Abrir men칰" aria-expanded="false" aria-controls="main-nav">
        <span class="hamburger-bar"></span>
        <span class="hamburger-bar"></span>
        <span class="hamburger-bar"></span>
    </button>

    <nav id="main-nav">
        <button id="menu-close" class="menu-close" aria-label="Cerrar men칰">&times;</button>

        <menu>
            {menuItems.map((item) => {
                const hasChildren = item.children && item.children.length > 0;
                
                return (
                    <li class:list={[item.classes, { 'has-dropdown': hasChildren }]}>
                        
                        {/* CASO A: TIENE SUBMEN칔 (IDIOMAS) */}
                        {hasChildren ? (
                            <>
                                <button type="button" class="dropdown-trigger" aria-expanded="false">
                                    <span class="item-content" set:html={item.title} />
                                    <svg class="chevron" width="10" height="6" viewBox="0 0 10 6" fill="none"><path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                </button>
                                
                                <ul class="dropdown-menu">
                                    {item.children.map((child) => (
                                        <li class={child.classes}>
                                            <a href={child.url}>
                                                <span class="item-content" set:html={child.title} />
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </>
                        ) : (
                            /* CASO B: ENLACE NORMAL */
                            <a href={item.url} target={item.target}>
                                <span class="item-content" set:html={item.title} />
                            </a>
                        )}
                    </li>
                );
            })}
        </menu>
    </nav>
</header>

<script>
    // --- L칍GICA MENU M칍VIL (TU C칍DIGO ORIGINAL) ---
    const nav = document.getElementById('main-nav');
    const toggleBtn = document.getElementById('menu-toggle');
    const closeBtn = document.getElementById('menu-close');

    function toggleMenu() {
        nav?.classList.toggle('is-open');
        const isOpen = nav?.classList.contains('is-open');
        toggleBtn?.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }

    toggleBtn?.addEventListener('click', toggleMenu);
    closeBtn?.addEventListener('click', toggleMenu);

    // --- L칍GICA NUEVA: DROPDOWN (SELECT DE IDIOMA) ---
    const dropdowns = document.querySelectorAll('.has-dropdown');

    dropdowns.forEach((dropdown) => {
        const trigger = dropdown.querySelector('.dropdown-trigger');
        
        trigger?.addEventListener('click', (e) => {
            e.stopPropagation(); // Evita conflictos
            const isOpen = dropdown.classList.contains('is-open');

            // Cierra otros dropdowns si hubiera m치s de uno
            document.querySelectorAll('.has-dropdown.is-open').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('is-open');
                    d.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
                }
            });

            // Alterna el actual
            if (isOpen) {
                dropdown.classList.remove('is-open');
                trigger.setAttribute('aria-expanded', 'false');
            } else {
                dropdown.classList.add('is-open');
                trigger.setAttribute('aria-expanded', 'true');
            }
        });
    });

    // Cerrar dropdown al hacer click fuera
    document.addEventListener('click', (e) => {
        if (!(e.target as HTMLElement).closest('.has-dropdown')) {
            document.querySelectorAll('.has-dropdown.is-open').forEach(d => {
                d.classList.remove('is-open');
                d.querySelector('.dropdown-trigger')?.setAttribute('aria-expanded', 'false');
            });
        }
    });
</script>

<style>
    header {    
        display: flex;
        justify-content: space-between;
        align-items: center; 
        padding-inline: 5rem;
        padding-block: 1.5rem;
        position: relative; 
        
        > figure {
            display: flex;
            align-items: center;
            justify-content: center;
            inline-size: auto;
            block-size: 40px;
            
            & a {
                flex: 1;
                inline-size: auto;
                block-size: 100%;
            
                > img {
                    inline-size: auto;
                    max-block-size: 100%;
                    object-fit: contain;
                }
            }
        }

        & nav {
            display: grid;
            place-content: center;

            & menu {
                display: flex;
                align-items: center;
                font-family: 'Geologica';
                list-style-type: none;
                gap: clamp(1.5rem, -0.074rem + 3.28vw, 3rem);
                /* Necesario para que el dropdown absoluto no se corte */
                position: relative; 
    
                & li {
                    /* Quitamos el scale global para evitar problemas con el dropdown */
                    /* Lo aplicaremos solo a los enlaces directos o al trigger */
                    transition: .3s transform ease-out;
                    position: relative; /* Para anclar el dropdown */
                }

                /* Efecto Hover solo para enlaces normales y el bot칩n trigger */
                & li > a, 
                & li > .dropdown-trigger {
                    color: var(--color-base);
                    text-decoration: none;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: transform 0.3s ease-out;
                }

                /* Tu efecto de escala y brillo */
                & li:not(.has-dropdown):hover {
                   transform: scale(1.25);
                   filter: brightness(2);
                }
                
                /* Para el dropdown, hacemos el efecto m치s sutil para no mover el men칰 desplegado */
                & li.has-dropdown:hover > .dropdown-trigger {
                    filter: brightness(2);
                }

                /* --- ESTILOS ESPEC칈FICOS DEL DROPDOWN --- */
                
                .dropdown-trigger {
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-family: inherit;
                    font-size: inherit;
                    padding: 0;
                }

                .chevron {
                    transition: transform 0.3s ease;
                }

                /* Rotar flecha cuando est치 abierto */
                & li.has-dropdown.is-open .chevron {
                    transform: rotate(180deg);
                }

                /* El Men칰 Desplegable (La cajita blanca) */
                .dropdown-menu {
                    position: absolute;
                    top: 150%; /* Un poco separado del bot칩n */
                    right: 0; /* Alineado a la derecha */
                    
                    background-color: var(--color-accent); /* Mismo fondo que header */
                    /* O usa 'white' si quieres contraste */
                    
                    border: 1px solid rgba(0,0,0,0.1);
                    border-radius: 8px;
                    padding: 0.5rem 0;
                    min-width: 140px;
                    
                    display: flex;
                    flex-direction: column;
                    gap: 0;
                    
                    opacity: 0;
                    visibility: hidden;
                    transform: translateY(10px);
                    transition: all 0.2s ease-in-out;
                    z-index: 100;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                }

                /* Mostrar men칰 cuando tiene la clase .is-open */
                & li.has-dropdown.is-open .dropdown-menu {
                    opacity: 1;
                    visibility: visible;
                    transform: translateY(0);
                }

                /* Elementos dentro del dropdown */
                .dropdown-menu li {
                    width: 100%;
                    display: block;
                }
                
                .dropdown-menu a {
                    padding: 0.5rem 1rem;
                    display: flex;
                    width: 100%;
                    white-space: nowrap;
                }

                .dropdown-menu a:hover {
                    background-color: rgba(255,255,255,0.1); /* Efecto hover sutil */
                }
            }
        }
    }

    /* --- ESTILOS PARA LAS BANDERAS (GLOBAL) --- */
    /* Como usamos set:html, necesitamos :global para llegar a la img */
    :global(.item-content) {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    :global(.item-content img) {
        width: 18px;
        height: auto;
        display: block;
    }

    .bg {
        background-color: var(--color-accent);
    }

    .bg--eu {
        background-color: var(--color-accent-2);
    }

    /* --- ESTILOS RESPONSIVE --- */

    .menu-toggle,
    .menu-close {
        display: none; 
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.5rem;
    }

    .menu-toggle {
        flex-direction: column;
        gap: 5px;
    }
    .hamburger-bar {
        display: block;
        width: 25px;
        height: 3px;
        background-color: var(--color-base, black); 
    }
    #main-nav {
        z-index: 99;
    }
    .menu-close {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        font-size: 2.5rem;
        color: var(--color-base, black);
        line-height: 1;
    }


    @media (max-width: 768px) {
        header {
            padding-inline: 1.5rem; 
        }

        .menu-toggle {
            display: flex; 
        }

        header > nav {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(80vw, 320px); 
            
            background-color: var(--color-accent);
            box-shadow: -5px 0 15px rgba(0,0,0,0.15);
            
            transform: translateX(100%);
            /* transition: transform 0.3s ease-in-out; */
            
            display: flex;
            padding: 6rem 2rem 2rem; 
            z-index: 9; 
          
        }

        header > nav.is-open {
            transform: translateX(0); 
            transition: transform 0.3s ease-in-out;
        }

        .menu-close {
            display: block; 
        }

        header > nav > menu {
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            align-items: flex-start; /* Alineamos a la izquierda en m칩vil */
        }

        header > nav > menu a,
        header > nav > menu .dropdown-trigger {
            font-size: 1.25rem; 
            width: 100%;
            justify-content: flex-start;
        }

        /* Ajustes del Dropdown en M칩vil: Que no flote, sino que empuje */
        header > nav > menu .dropdown-menu {
            position: static; /* Deja de flotar */
            transform: none;
            opacity: 1;
            visibility: visible;
            
            /* Lo ocultamos con display none por defecto para animar altura si quisieras, o simple display */
            display: none; 
            background-color: transparent;
            box-shadow: none;
            border: none;
            padding-left: 1rem; /* Indentaci칩n */
            min-width: auto;
        }

        header > nav > menu li.has-dropdown.is-open .dropdown-menu {
            display: flex; /* Se muestra debajo */
        }
        
        /* Quitamos rotaci칩n de flecha si quieres o la ajustas */
        header > nav > menu .chevron {
            margin-left: auto; /* Empuja la flecha a la derecha */
        }
    }
</style>